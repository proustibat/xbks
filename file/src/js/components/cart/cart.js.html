<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">src/js/components/cart/cart.js | XBKS</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Fake e-commerce website"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="XBKS"><meta property="twitter:description" content="Fake e-commerce website"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/proustibat/xbks"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js">js</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/layout.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Utils">Utils</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-components-book-preview">js/components/book-preview</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/components/book-preview/book-preview.js~BookPreview.html">BookPreview</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-components-books-list">js/components/books-list</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/components/books-list/books-list.js~BooksList.html">BooksList</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-components-cart">js/components/cart</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/components/cart/cart.js~Cart.html">Cart</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-pages">js/pages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/pages/home.js~Home.html">Home</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-services">js/services</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/services/api-potier.js~ApiPotier.html">ApiPotier</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/js/components/cart/cart.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { default as template } from &apos;./cart.hbs&apos;;
import Layout from &apos;../../layout&apos;;
import Utils from &apos;../../utils&apos;;
import ApiPotier from &apos;../../services/api-potier&apos;;
import Lockr from &apos;lockr&apos;;

let instance = null;

export default class Cart {
    constructor () {
        if ( !instance ) {
            instance = this;
        }

        this.el = null;
        this.content = null;
        this.$modal = null;
        this.layout = null;
        this.api = new ApiPotier();

        return instance;
    }

    async init ( el ) {
        this.el = el;
        this.items = [];
        this.discount = null;
        this.subTotal = null;
        this.totalOrder = null;
        this.offers = null;

        this.content = document.createElement( &apos;div&apos; );

        // Listen to layout for click on cart menu item
        this.layout = new Layout();
        this.layout.on( &apos;open-cart&apos;, this.onOpenCart.bind( this ) );

        // Retrieve items if existing from the localStorage
        Lockr.prefix = &apos;xbks&apos;;
        const localStorageItems = Lockr.get( &apos;cart-items&apos; );
        if ( localStorageItems ) {
            this.items = localStorageItems;
            await this.updateTotals();
        }

        this.render();
    }

    initModal () {
        this.$modal = $( &apos;.modal-cart&apos; );
        this.$modal.modal( {
            opacity: 0.9, // Opacity of modal background
            inDuration: 200, // Transition in duration
            outDuration: 200, // Transition out duration
            // Callback for Modal open. Modal and trigger parameters available.
            // ready: this.onModalOpen.bind( this ),
            // Callback for Modal close
            // complete: this.onModalClose.bind( this )
        } );
    }

    onOpenCart () {
        this.$modal.modal( &apos;open&apos; );
    }

    // onModalOpen () {
    //     console.log( &apos;onModalOpen&apos; );
    // }
    //
    // onModalClose () {
    //     console.log( &apos;onModalClose&apos; );
    // }

    async addBook ( { isbn, title, price } ) {
        return new Promise( async ( resolve ) =&gt; {
            // this.layout.displayMainLoader();

            // Updates books list
            const index = this.items.findIndex( item =&gt; item.isbn === isbn );
            // if item already exists in the cart, just increment the quantity
            if ( index &gt;= 0 ) {
                this.items[ index ].quantity++;
            }
            else {
                this.items.push( {
                    isbn: isbn,
                    title: title,
                    price: price,
                    quantity: 1
                } );
            }

            // Save items into the localStorage
            Lockr.set( &apos;cart-items&apos;, this.items );

            await this.updateTotals();

            await this.render();

            // this.layout.removeMainLoader();
            resolve();
        } );
    }

    async updateTotals () {
        console.log( &apos;updateTotals&apos; );
        // Update total without reduction
        await this.updateSubTotal();

        // Update discount object
        await this.updateDiscount();

        // Update total with applied reduction
        this.totalOrder = this.subTotal - this.discount.amount;
    }

    async updateDiscount () {
        console.log( &apos;updateDiscount&apos; );
        await this.findOffers();
        this.discount = this.findBestReduction();
    }

    async findOffers () {
        console.log( &apos;findOffers&apos; );
        // Get list of all isbn
        // ( if there is more than one time, we must add its isbn more than one time)
        const isbnList = [];
        this.items.forEach( book =&gt; {
            for ( let i = 0; i &lt; book.quantity; i++ ) {
                isbnList.push( book.isbn );
            }
        } );

        await this.api.getOffers( isbnList )
            .then( data =&gt; { this.offers = data; } )
            .catch( error =&gt; { console.error( error ); } );
    }

    findBestReduction () {
        const discounts = [];
        this.offers.forEach( offer =&gt; {
            discounts.push( offer );
            switch ( offer.type ) {
            case &apos;percentage&apos;:
                discounts[ discounts.length - 1 ].amount = offer.value / 100 * this.subTotal;
                break;
            case &apos;minus&apos;:
                discounts[ discounts.length - 1 ].amount = offer.value;
                break;
            case &apos;slice&apos;:
                discounts[ discounts.length - 1 ].amount = Math.floor( this.subTotal / offer.sliceValue ) * offer.value;
                break;
            default:
                break;
            }
        } );
        // we need to compare amount and keep all the other stuff
        return discounts.reduce( ( maxOffer, offer ) =&gt; offer.amount &gt; maxOffer.amount ? offer : maxOffer, discounts[0] );
    }

    updateSubTotal () {
        console.log( &apos;updateSubTotal&apos; );
        if ( this.items.length &gt; 0 ) {
            // update total without reduction (subtotal)
            const reducedSum = this.items.reduce( ( acc, item ) =&gt; {
                const price1 = ( acc.price * ( acc.quantity || 1 ) );
                const price2 = ( item.price * ( item.quantity || 1 ) );
                return ( { price: price1 + price2 } );
            } );
            // if there is only one item in the cart, this is the original item
            this.subTotal = reducedSum.price * ( reducedSum.quantity || 1 );
        }
        else {
            this.subTotal = 0;
            this.totalOrder = 0;
        }
    }

    render () {
        this.content.innerHTML = template( {
            items: this.items.map( item =&gt; {
                return Object.assign( {}, item, {
                    total: Utils.toLocalCurrency( item.price * item.quantity ),
                    price: Utils.toLocalCurrency( item.price )
                } );
            } ),
            discount: Object.assign( {}, this.discount, { amount: this.discount ? Utils.toLocalCurrency( this.discount.amount ) : null } ),
            subTotal: this.subTotal !== null ? Utils.toLocalCurrency( this.subTotal ) : &apos;jjj&apos;,
            totalOrder: this.totalOrder !== null ? Utils.toLocalCurrency( this.totalOrder ) : 0
        } );

        this.el.innerHTML = this.content.innerHTML;
        this.initModal();
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
